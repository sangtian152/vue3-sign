"use strict";Object.defineProperties(exports,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}});const s=require("vue"),ae="@sangtian152/vue3-sign",se="sangtian152",re="0.0.3",ie="lib/vue3-sign.umd.js",le="lib/vue3-sign.mjs",ce={".":{import:"./lib/vue3-sign.mjs",require:"./lib/vue3-sign.umd.cjs"}},ue="lib/index.d.ts",de="MIT",pe="https://sangtian152.github.io/vue3-sign",fe=["lib"],ve={dev:"vuepress dev docs",build:"npm run build:lib && npm run build:docs","build:docs":"vuepress build docs","build:lib":"vue-tsc --noEmit --skipLibCheck && vite build --outDir lib","build:esm":"gulp --require sucrase/register/ts -f build/gulpfile.ts"},ge={},me={vue:"^3.2.47"},he={"@rollup/plugin-json":"^6.0.0","@rollup/plugin-node-resolve":"^15.0.1","@types/gulp":"^4.0.10","@types/gulp-sass":"^5.0.0","@vitejs/plugin-vue":"^4.1.0","@vuepress/client":"^2.0.0-beta.61","element-plus":"^2.3.1","escape-html":"^1.0.3",gulp:"^4.0.2","gulp-rename":"^2.0.0","gulp-sass":"^5.1.0","markdown-it":"^13.0.1","markdown-it-container":"^3.0.0",rollup:"^3.20.2","rollup-plugin-terser":"^7.0.2","rollup-plugin-typescript2":"^0.34.1","rollup-plugin-vue":"^6.0.0",sass:"^1.60.0","sass-loader":"^13.2.2",sucrase:"^3.31.0",typescript:"^4.9.3","unplugin-element-plus":"^0.7.0","unplugin-vue-define-options":"^1.3.2",vite:"^4.2.0","vite-plugin-dts":"^2.1.0","vue-tsc":"^1.2.0",vuepress:"^2.0.0-beta.61"},J={name:ae,author:se,private:!1,version:re,main:ie,module:le,exports:ce,typings:ue,license:de,homepage:pe,files:fe,scripts:ve,dependencies:ge,peerDependencies:me,devDependencies:he},y=function(e){return typeof e=="string"},be=function(e){return typeof e=="number"},we=function(e){let o=-1;const i=e?e.length:0,c={};for(;++o<i;){const u=e[o];c[u[0]]=u[1]}return c},S=typeof window<"u"&&"ontouchstart"in window,x=function(){return{tapstart:S?"touchstart":"mousedown",tapmove:S?"touchmove":"mousemove",tapend:S?"touchend":"mouseup"}},V=function(e,o){try{let i=S?e.targetTouches[0].pageX:e.offsetX,c=S?e.targetTouches[0].pageY:e.offsetY;if(S){let u=o;for(;u&&u.tagName!=="BODY";)i-=u.offsetLeft,c-=u.offsetTop,u=u.offsetParent}return{x:i,y:c}}catch(i){console.log(i)}},E={print:(e,o,i)=>y(o)||typeof i=="boolean",pretty:(e,o,i)=>y(o)&&y(e)||typeof i=="string",primary:(e,o)=>y(e)||typeof o=="boolean",success:(e,o)=>y(e)||typeof o=="boolean",info:(e,o)=>y(e)||typeof o=="boolean",warning:(e,o)=>y(e)||typeof o=="boolean",danger:(e,o)=>y(e)||typeof o=="boolean"};function D(e="default"){let o="";switch(e){case"primary":o="#2d8cf0";break;case"success":o="#19be6b";break;case"info":o="#909399";break;case"warning":o="#ff9900";break;case"danger":o="#ff4d4f";break;case"default":o="#35495E";break;default:o=e;break}return o}E.print=function(e,o="default",i=!1){return typeof e=="object"?(console.dir(e),!0):(i?console.log(`%c ${e} `,`background:${D(o)}; padding: 2px; border-radius: 4px;color: #fff;`):console.log(`%c ${e} `,`color: ${D(o)};`),!0)};E.pretty=function(e,o,i="primary"){return console.log(`%c ${e} %c ${o} %c`,`background:${D(i)};border:1px solid ${D(i)}; padding: 1px; border-radius: 4px 0 0 4px; color: #fff;`,`border:1px solid ${D(i)}; padding: 1px; border-radius: 0 4px 4px 0; color: ${D(i)};`,"background:transparent"),!0};E.primary=function(e,o=!1){return this.print&&this.print(e,"primary",o),!0};E.success=function(e,o=!1){return this.print&&this.print(e,"success",o),!0};E.info=function(e,o=!1){return this.print&&this.print(e,"info",o),!0};E.warning=function(e,o=!1){return this.print&&this.print(e,"warning",o),!0};E.danger=function(e,o=!1){return this.print&&this.print(e,"danger",o),!0};const ye={async install(e){e.config.globalProperties.$log=E,E.pretty("["+J.name+"] "+J.version,"success")}};process.env.NODE_ENV!=="production"&&Object.freeze({});process.env.NODE_ENV!=="production"&&Object.freeze([]);const Ee=e=>e!==null&&typeof e=="object",F=Symbol("wrapper"),K="__elPropsReservedKey";function Ce(e,o){if(!Ee(e)||e[K])return e;const{values:i,required:c,default:u,type:h,validator:d}=e,b=i||d?m=>{let w=!1,C=[];if(i&&(C=[...i,u],w=w||C.includes(m)),d&&(w=w||d(m)),!w&&C.length>0){const N=[...new Set(C)].map(R=>JSON.stringify(R)).join(", ");s.warn(`Invalid prop: validation failed${o?` for prop "${o}"`:""}. Expected one of [${N}], got value ${JSON.stringify(m)}.`)}return w}:void 0;return{type:typeof h=="object"&&h!==null&&Object.getOwnPropertySymbols(h).includes(F)?h[F]:h,validator:b,[K]:!0,default:u,required:!!c}}const ke=e=>we(Object.entries(e).map(([o,i])=>[o,Ce(i,o)])),xe=ke({canvasWidth:Number,canvasHeight:Number,lineColor:{type:String,default:"#000"},lineWidth:{type:Number,default:3},bgColor:{type:String,default:"#f7f7f7"},imgBgColor:{type:String,default:"transparent"},crop:{type:Boolean,default:!0},footer:{type:Boolean,default:!0},beforeDone:Function,erasable:{type:Boolean,default:!0},eraserRadius:{type:Number,default:6}}),De={"on-clear":()=>!0,"on-done":e=>y(e),orientationchange:e=>be(e)},Se={class:"zm-sign"},_e={key:0,class:"zm-sign-tool"},Ne={class:"can_vans"},Le=["width","height"],$e={key:1,class:"zm-sign-handle"},Oe=s.defineComponent({name:"Vue3Sign"}),_=s.defineComponent({...Oe,props:xe,emits:De,setup(e,{expose:o,emit:i}){const c=e,u=s.ref(0),h=s.ref(0);s.watch(()=>c.canvasWidth,t=>{u.value=t}),s.watch(()=>c.canvasHeight,t=>{h.value=t});const d=s.ref(),b=s.ref();s.onMounted(()=>{const t=d.value;t.style.background=c.bgColor,b.value=t.getContext("2d",{willReadFrequently:!0}),N(!0),document.onmouseup=()=>{L()};const{tapstart:n,tapend:r}=x();if(document.addEventListener(r,L),t.addEventListener(n,A,{passive:!1}),typeof window<"u"){const a="onorientationchange"in window?"orientationchange":"resize";window.addEventListener(a,N,!1)}}),s.onBeforeUnmount(()=>{const{tapend:t}=x();if(document.removeEventListener(t,L),typeof window<"u"){const n="onorientationchange"in window?"orientationchange":"resize";window.removeEventListener(n,N,!1)}});const m=s.ref(!1),w=t=>{m.value=t,m.value?ne(d.value):te(d.value)},C=s.ref(!1),N=t=>{const n=window.orientation;C.value=n==0||n==180,setTimeout(()=>{const r=window.innerWidth,a=window.innerHeight;C?R(r,a):U(r,a)},50),t!==!0&&i("orientationchange",n)},R=(t,n)=>{u.value=t-40,h.value=n/2},U=(t,n)=>{u.value=t-40,h.value=n-120},z=s.ref(!1),j=s.ref(!1),B=s.ref(0),I=s.ref(0),A=t=>{if(t.cancelable&&t.preventDefault(),m.value)return;const n=V(t,d.value);if(n){z.value=!0,j.value=!0,B.value=n.x,I.value=n.y;const p=b.value;p.lineCap="round",p.lineJoin="round",p.strokeStyle=c.lineColor,p.lineWidth=c.lineWidth,M(n,"source-over")}const{tapmove:r,tapend:a}=x(),l=d.value;l.addEventListener(r,T,{passive:!1}),l.addEventListener(a,W,{passive:!1})},T=t=>{if(t.cancelable&&t.preventDefault(),m.value||!z.value)return;const n=V(t,d.value);n&&(M(n,null),I.value=n.y,B.value=n.x)},W=t=>{if(t.cancelable&&t.preventDefault(),m.value)return;const n=d.value,{tapmove:r,tapend:a}=x();n.removeEventListener(r,T),n.removeEventListener(a,W)},M=({x:t,y:n},r)=>{const a=b.value;r&&(a.globalCompositeOperation=r),a.beginPath(),a.moveTo(B.value,I.value),a.lineTo(t,n),a.stroke(),a.closePath()},L=()=>{z.value=!1},H=()=>new Promise((n,r)=>{if(!j.value){r("Warning: Not Signned!");return}const a=d.value,l=b.value,p=l.getImageData(0,0,a.width,a.height);l.globalCompositeOperation="destination-over",l.fillStyle=c.bgColor,l.fillRect(0,0,a.width,a.height);let f=a.toDataURL();if(l.clearRect(0,0,a.width,a.height),l.putImageData(p,0,0),l.globalCompositeOperation="source-over",c.crop){const g=G(p.data),v=document.createElement("canvas"),k=v.getContext("2d",{willReadFrequently:!0});v.width=g[2]-g[0],v.height=g[3]-g[1];const oe=l.getImageData(...g);k.globalCompositeOperation="destination-over",k.putImageData(oe,0,0),k.fillStyle=c.imgBgColor,k.fillRect(0,0,v.width,v.height),f=v.toDataURL(),v.width>0&&v.height>0?n(f):r("Warning: Not Signned!")}w(m.value),n(f)}),G=t=>{const n=d.value;for(var r=n.width,a=0,l=n.height,p=0,f=0;f<n.width;f++)for(var g=0;g<n.height;g++){var v=(f+n.width*g)*4;(t[v]>0||t[v+1]>0||t[v+2]||t[v+3]>0)&&(p=Math.max(g,p),a=Math.max(f,a),l=Math.min(g,l),r=Math.min(f,r))}return r++,a++,l++,p++,[r,l,a,p]},Q=()=>{q(),i("on-clear")},$=s.ref(""),Z=()=>{let t=d.value,n=!0;c.beforeDone&&typeof c.beforeDone=="function"&&(n=c.beforeDone(t)),n&&H().then(r=>{$.value=r,i("on-done",$.value)}).catch(()=>{$.value="",i("on-done","")})},q=()=>{j.value=!1,w(m.value);const t=d.value;b.value.clearRect(0,0,t.width,t.height),$.value="",L()},ee=async()=>await H(),te=t=>{const{tapstart:n}=x();b.value.globalCompositeOperation="source-over",t.removeEventListener(n,Y)},ne=t=>{if(!c.erasable)return;const{tapstart:n}=x(),r=b.value;r.lineCap="round",r.lineJoin="round",r.lineWidth=c.eraserRadius*2,r.globalCompositeOperation="destination-out",t.addEventListener(n,Y,{passive:!1})},O=s.ref(0),P=s.ref(0),Y=t=>{t.preventDefault();const n=d.value,{tapmove:r,tapend:a}=x();let l,p,f=V(t,n);O.value=f.x,P.value=f.y,X(O.value,P.value),n.addEventListener(r,v,{passive:!1}),n.addEventListener(a,g,{passive:!1});function g(){n.removeEventListener(r,v),n.removeEventListener(a,g)}function v(k){k.preventDefault(),f=V(k,n),f&&(l=f.x,p=f.y,X(O.value,P.value,l,p),O.value=l,P.value=p)}},X=(t,n,r,a)=>{const l=b.value;l.save(),l.beginPath(),r!==void 0&&a!==void 0?(l.arc(t,n,c.eraserRadius,0,2*Math.PI),l.fill()):(l.moveTo(t,n),l.lineTo(r,a),l.stroke()),l.restore()};return o({clear:q,done:ee}),(t,n)=>(s.openBlock(),s.createElementBlock("div",Se,[t.erasable?(s.openBlock(),s.createElementBlock("div",_e,[s.createElementVNode("span",{class:s.normalizeClass(["iconfont","icon-eraser",{active:m.value}]),onClick:n[0]||(n[0]=r=>w(!m.value))},null,2)])):s.createCommentVNode("",!0),s.createElementVNode("div",Ne,[s.createElementVNode("canvas",{ref_key:"canvasRef",ref:d,width:t.canvasWidth?t.canvasWidth:u.value,height:t.canvasHeight?t.canvasHeight:h.value},null,8,Le)]),t.footer?(s.openBlock(),s.createElementBlock("div",$e,[s.createElementVNode("button",{class:"zm-button zm-button--mini",onClick:Q}," 清空 "),s.createElementVNode("button",{class:"zm-button zm-button--mini",onClick:Z}," 完成 ")])):s.createCommentVNode("",!0)]))}});_.install=function(e){e.component(_.name,_)};const Pe=[_],Ve=function(e){Pe.forEach(o=>{e.component(o.name,o)}),e.use(ye)},Re={install:Ve,Vue3Sign:_};exports.Vue3Sign=_;exports.default=Re;
