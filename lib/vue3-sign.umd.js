(function(E,a){typeof exports=="object"&&typeof module<"u"?a(exports,require("vue")):typeof define=="function"&&define.amd?define(["exports","vue"],a):(E=typeof globalThis<"u"?globalThis:E||self,a(E.Vue3Sign={},E.Vue))})(this,function(E,a){"use strict";const W={name:"@sangtian152/vue3-sign",author:"sangtian152",private:!1,version:"0.0.1",main:"lib/vue3-sign.umd.js",module:"lib/vue3-sign.mjs",exports:{".":{import:"./lib/vue3-sign.mjs",require:"./lib/vue3-sign.umd.cjs"}},typings:"lib/index.d.ts",license:"MIT",homepage:"https://sangtian152.github.io/vue3-sign",files:["lib"],scripts:{dev:"vuepress dev docs",build:"npm run build:lib && npm run build:docs","build:docs":"vuepress build docs","build:lib":"vue-tsc --noEmit --skipLibCheck && vite build --outDir lib","build:esm":"gulp --require sucrase/register/ts -f build/gulpfile.ts"},dependencies:{},peerDependencies:{vue:"^3.2.47"},devDependencies:{"@rollup/plugin-json":"^6.0.0","@rollup/plugin-node-resolve":"^15.0.1","@types/gulp":"^4.0.10","@types/gulp-sass":"^5.0.0","@vitejs/plugin-vue":"^4.1.0","@vuepress/client":"^2.0.0-beta.61","element-plus":"^2.3.1","escape-html":"^1.0.3",gulp:"^4.0.2","gulp-rename":"^2.0.0","gulp-sass":"^5.1.0","markdown-it":"^13.0.1","markdown-it-container":"^3.0.0",rollup:"^3.20.2","rollup-plugin-terser":"^7.0.2","rollup-plugin-typescript2":"^0.34.1","rollup-plugin-vue":"^6.0.0",sass:"^1.60.0","sass-loader":"^13.2.2",sucrase:"^3.31.0",typescript:"^4.9.3","unplugin-element-plus":"^0.7.0","unplugin-vue-define-options":"^1.3.2",vite:"^4.2.0","vite-plugin-dts":"^2.1.0","vue-tsc":"^1.2.0",vuepress:"^2.0.0-beta.61"}},y=function(e){return typeof e=="string"},F=function(e){return typeof e=="number"},G=function(e){let n=-1;const i=e?e.length:0,c={};for(;++n<i;){const u=e[n];c[u[0]]=u[1]}return c},D=typeof window<"u"&&"ontouchstart"in window,C=function(){return{tapstart:D?"touchstart":"mousedown",tapmove:D?"touchmove":"mousemove",tapend:D?"touchend":"mouseup"}},O=function(e,n){try{let i=D?e.targetTouches[0].pageX:e.offsetX,c=D?e.targetTouches[0].pageY:e.offsetY;if(D){let u=n;for(;u&&u.tagName!=="BODY";)i-=u.offsetLeft,c-=u.offsetTop,u=u.offsetParent}return{x:i,y:c}}catch(i){console.log(i)}},_={print:(e,n,i)=>y(n)||typeof i=="boolean",pretty:(e,n,i)=>y(n)&&y(e)||typeof i=="string",primary:(e,n)=>y(e)||typeof n=="boolean",success:(e,n)=>y(e)||typeof n=="boolean",info:(e,n)=>y(e)||typeof n=="boolean",warning:(e,n)=>y(e)||typeof n=="boolean",danger:(e,n)=>y(e)||typeof n=="boolean"};function S(e="default"){let n="";switch(e){case"primary":n="#2d8cf0";break;case"success":n="#19be6b";break;case"info":n="#909399";break;case"warning":n="#ff9900";break;case"danger":n="#ff4d4f";break;case"default":n="#35495E";break;default:n=e;break}return n}_.print=function(e,n="default",i=!1){return typeof e=="object"?(console.dir(e),!0):(i?console.log(`%c ${e} `,`background:${S(n)}; padding: 2px; border-radius: 4px;color: #fff;`):console.log(`%c ${e} `,`color: ${S(n)};`),!0)},_.pretty=function(e,n,i="primary"){return console.log(`%c ${e} %c ${n} %c`,`background:${S(i)};border:1px solid ${S(i)}; padding: 1px; border-radius: 4px 0 0 4px; color: #fff;`,`border:1px solid ${S(i)}; padding: 1px; border-radius: 0 4px 4px 0; color: ${S(i)};`,"background:transparent"),!0},_.primary=function(e,n=!1){return this.print&&this.print(e,"primary",n),!0},_.success=function(e,n=!1){return this.print&&this.print(e,"success",n),!0},_.info=function(e,n=!1){return this.print&&this.print(e,"info",n),!0},_.warning=function(e,n=!1){return this.print&&this.print(e,"warning",n),!0},_.danger=function(e,n=!1){return this.print&&this.print(e,"danger",n),!0};const Q={async install(e){e.config.globalProperties.$log=_,_.pretty("["+W.name+"] "+W.version,"success")}};process.env.NODE_ENV!=="production"&&Object.freeze({}),process.env.NODE_ENV!=="production"&&Object.freeze([]);const Z=e=>e!==null&&typeof e=="object",M=Symbol("wrapper"),H="__elPropsReservedKey";function ee(e,n){if(!Z(e)||e[H])return e;const{values:i,required:c,default:u,type:h,validator:d}=e,b=i||d?m=>{let w=!1,x=[];if(i&&(x=[...i,u],w=w||x.includes(m)),d&&(w=w||d(m)),!w&&x.length>0){const L=[...new Set(x)].map(z=>JSON.stringify(z)).join(", ");a.warn(`Invalid prop: validation failed${n?` for prop "${n}"`:""}. Expected one of [${L}], got value ${JSON.stringify(m)}.`)}return w}:void 0;return{type:typeof h=="object"&&h!==null&&Object.getOwnPropertySymbols(h).includes(M)?h[M]:h,validator:b,[H]:!0,default:u,required:!!c}}const te=(e=>G(Object.entries(e).map(([n,i])=>[n,ee(i,n)])))({canvasWidth:Number,canvasHeight:Number,lineColor:{type:String,default:"#000"},lineWidth:{type:Number,default:3},bgColor:{type:String,default:"#f7f7f7"},imgBgColor:{type:String,default:"transparent"},crop:{type:Boolean,default:!0},footer:{type:Boolean,default:!0},beforeDone:Function,erasable:{type:Boolean,default:!0},eraserRadius:{type:Number,default:6}}),ne={"on-clear":()=>!0,"on-done":e=>y(e),orientationchange:e=>F(e)},oe={class:"zm-sign"},ae={key:0,class:"zm-sign-tool"},se={class:"can_vans"},re=["width","height"],ie={key:1,class:"zm-sign-handle"},le=a.defineComponent({name:"Vue3Sign"}),ce=a.defineComponent({...le,props:te,emits:ne,setup(e,{expose:n,emit:i}){const c=e,u=a.ref(0),h=a.ref(0);a.watch(()=>c.canvasWidth,t=>{u.value=t}),a.watch(()=>c.canvasHeight,t=>{h.value=t});const d=a.ref(),b=a.ref();a.onMounted(()=>{const t=d.value;t.style.background=c.bgColor,b.value=t.getContext("2d"),L(!0),document.onmouseup=()=>{V()};const{tapstart:o,tapend:r}=C();if(document.addEventListener(r,V),t.addEventListener(o,fe,{passive:!1}),typeof window<"u"){const s="onorientationchange"in window?"orientationchange":"resize";window.addEventListener(s,L,!1)}}),a.onBeforeUnmount(()=>{const{tapend:t}=C();if(document.removeEventListener(t,V),typeof window<"u"){const o="onorientationchange"in window?"orientationchange":"resize";window.removeEventListener(o,L,!1)}});const m=a.ref(!1),w=t=>{m.value=t,m.value?we(d.value):be(d.value)},x=a.ref(!1),L=t=>{const o=window.orientation;x.value=o==0||o==180,setTimeout(()=>{const r=window.innerWidth,s=window.innerHeight;x?z(r,s):pe(r,s)},50),t!==!0&&i("orientationchange",o)},z=(t,o)=>{u.value=t-40,h.value=o/2},pe=(t,o)=>{u.value=t-40,h.value=o-120},I=a.ref(!1),T=a.ref(!1),B=a.ref(0),R=a.ref(0),fe=t=>{if(t.cancelable&&t.preventDefault(),m.value)return;const o=O(t,d.value);if(o){I.value=!0,T.value=!0,B.value=o.x,R.value=o.y;const p=b.value;p.lineCap="round",p.lineJoin="round",p.strokeStyle=c.lineColor,p.lineWidth=c.lineWidth,X(o,"source-over")}const{tapmove:r,tapend:s}=C(),l=d.value;l.addEventListener(r,Y,{passive:!1}),l.addEventListener(s,q,{passive:!1})},Y=t=>{if(t.cancelable&&t.preventDefault(),m.value||!I.value)return;const o=O(t,d.value);o&&(X(o,null),R.value=o.y,B.value=o.x)},q=t=>{if(t.cancelable&&t.preventDefault(),m.value)return;const o=d.value,{tapmove:r,tapend:s}=C();o.removeEventListener(r,Y),o.removeEventListener(s,q)},X=({x:t,y:o},r)=>{const s=b.value;r&&(s.globalCompositeOperation=r),s.beginPath(),s.moveTo(B.value,R.value),s.lineTo(t,o),s.stroke(),s.closePath()},V=()=>{I.value=!1},J=()=>new Promise((o,r)=>{if(!T.value){r("Warning: Not Signned!");return}const s=d.value,l=b.value,p=l.getImageData(0,0,s.width,s.height);l.globalCompositeOperation="destination-over",l.fillStyle=c.bgColor,l.fillRect(0,0,s.width,s.height);let f=s.toDataURL();if(l.clearRect(0,0,s.width,s.height),l.putImageData(p,0,0),l.globalCompositeOperation="source-over",c.crop){const g=ve(p.data),v=document.createElement("canvas"),k=v.getContext("2d");v.width=g[2]-g[0],v.height=g[3]-g[1];const ye=l.getImageData(...g);k.globalCompositeOperation="destination-over",k.putImageData(ye,0,0),k.fillStyle=c.imgBgColor,k.fillRect(0,0,v.width,v.height),f=v.toDataURL(),v.width>0&&v.height>0?o(f):r("Warning: Not Signned!")}w(m.value),o(f)}),ve=t=>{const o=d.value;for(var r=o.width,s=0,l=o.height,p=0,f=0;f<o.width;f++)for(var g=0;g<o.height;g++){var v=(f+o.width*g)*4;(t[v]>0||t[v+1]>0||t[v+2]||t[v+3]>0)&&(p=Math.max(g,p),s=Math.max(f,s),l=Math.min(g,l),r=Math.min(f,r))}return r++,s++,l++,p++,[r,l,s,p]},ge=()=>{K(),i("on-clear")},$=a.ref(""),me=()=>{let t=d.value,o=!0;c.beforeDone&&typeof c.beforeDone=="function"&&(o=c.beforeDone(t)),o&&J().then(r=>{$.value=r,i("on-done",$.value)}).catch(()=>{$.value="",i("on-done","")})},K=()=>{T.value=!1,w(m.value);const t=d.value;b.value.clearRect(0,0,t.width,t.height),$.value="",V()},he=async()=>await J(),be=t=>{const{tapstart:o}=C();b.value.globalCompositeOperation="source-over",t.removeEventListener(o,U)},we=t=>{if(!c.erasable)return;const{tapstart:o}=C(),r=b.value;r.lineCap="round",r.lineJoin="round",r.lineWidth=c.eraserRadius*2,r.globalCompositeOperation="destination-out",t.addEventListener(o,U,{passive:!1})},P=a.ref(0),j=a.ref(0),U=t=>{t.preventDefault();const o=d.value,{tapmove:r,tapend:s}=C();let l,p,f=O(t,o);P.value=f.x,j.value=f.y,A(P.value,j.value),o.addEventListener(r,v,{passive:!1}),o.addEventListener(s,g,{passive:!1});function g(){o.removeEventListener(r,v),o.removeEventListener(s,g)}function v(k){k.preventDefault(),f=O(k,o),f&&(l=f.x,p=f.y,A(P.value,j.value,l,p),P.value=l,j.value=p)}},A=(t,o,r,s)=>{const l=b.value;l.save(),l.beginPath(),r!==void 0&&s!==void 0?(l.arc(t,o,c.eraserRadius,0,2*Math.PI),l.fill()):(l.moveTo(t,o),l.lineTo(r,s),l.stroke()),l.restore()};return n({clear:K,done:he}),(t,o)=>(a.openBlock(),a.createElementBlock("div",oe,[t.erasable?(a.openBlock(),a.createElementBlock("div",ae,[a.createElementVNode("span",{class:a.normalizeClass(["iconfont","icon-eraser",{active:m.value}]),onClick:o[0]||(o[0]=r=>w(!m.value))},null,2)])):a.createCommentVNode("",!0),a.createElementVNode("div",se,[a.createElementVNode("canvas",{ref_key:"canvasRef",ref:d,width:t.canvasWidth?t.canvasWidth:u.value,height:t.canvasHeight?t.canvasHeight:h.value},null,8,re)]),t.footer?(a.openBlock(),a.createElementBlock("div",ie,[a.createElementVNode("button",{class:"zm-buttom zm-button--mini",onClick:ge}," 清空 "),a.createElementVNode("button",{class:"zm-buttom zm-button--mini",onClick:me}," 完成 ")])):a.createCommentVNode("",!0)]))}}),Ie="",N=((e,n)=>{const i=e.__vccOpts||e;for(const[c,u]of n)i[c]=u;return i})(ce,[["__scopeId","data-v-2701f584"]]);N.install=function(e){e.component(N.name,N)};const ue=[N],de={install:function(e){ue.forEach(n=>{e.component(n.name,n)}),e.use(Q)},Vue3Sign:N};E.Vue3Sign=N,E.default=de,Object.defineProperties(E,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});
