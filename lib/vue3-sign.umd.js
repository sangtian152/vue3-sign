(function(C,a){typeof exports=="object"&&typeof module<"u"?a(exports,require("vue")):typeof define=="function"&&define.amd?define(["exports","vue"],a):(C=typeof globalThis<"u"?globalThis:C||self,a(C.Vue3Sign={},C.Vue))})(this,function(C,a){"use strict";const W={name:"@sangtian152/vue3-sign",author:"sangtian152",private:!1,version:"0.0.3",main:"lib/vue3-sign.umd.js",module:"lib/vue3-sign.mjs",exports:{".":{import:"./lib/vue3-sign.mjs",require:"./lib/vue3-sign.umd.cjs"}},typings:"lib/index.d.ts",license:"MIT",homepage:"https://sangtian152.github.io/vue3-sign",files:["lib"],scripts:{dev:"vuepress dev docs",build:"npm run build:lib && npm run build:docs","build:docs":"vuepress build docs","build:lib":"vue-tsc --noEmit --skipLibCheck && vite build --outDir lib","build:esm":"gulp --require sucrase/register/ts -f build/gulpfile.ts"},dependencies:{},peerDependencies:{vue:"^3.2.47"},devDependencies:{"@rollup/plugin-json":"^6.0.0","@rollup/plugin-node-resolve":"^15.0.1","@types/gulp":"^4.0.10","@types/gulp-sass":"^5.0.0","@vitejs/plugin-vue":"^4.1.0","@vuepress/client":"^2.0.0-beta.61","element-plus":"^2.3.1","escape-html":"^1.0.3",gulp:"^4.0.2","gulp-rename":"^2.0.0","gulp-sass":"^5.1.0","markdown-it":"^13.0.1","markdown-it-container":"^3.0.0",rollup:"^3.20.2","rollup-plugin-terser":"^7.0.2","rollup-plugin-typescript2":"^0.34.1","rollup-plugin-vue":"^6.0.0",sass:"^1.60.0","sass-loader":"^13.2.2",sucrase:"^3.31.0",typescript:"^4.9.3","unplugin-element-plus":"^0.7.0","unplugin-vue-define-options":"^1.3.2",vite:"^4.2.0","vite-plugin-dts":"^2.1.0","vue-tsc":"^1.2.0",vuepress:"^2.0.0-beta.61"}},y=function(e){return typeof e=="string"},A=function(e){return typeof e=="number"},G=function(e){let o=-1;const i=e?e.length:0,c={};for(;++o<i;){const u=e[o];c[u[0]]=u[1]}return c},S=typeof window<"u"&&"ontouchstart"in window,x=function(){return{tapstart:S?"touchstart":"mousedown",tapmove:S?"touchmove":"mousemove",tapend:S?"touchend":"mouseup"}},$=function(e,o){try{let i=S?e.targetTouches[0].pageX:e.offsetX,c=S?e.targetTouches[0].pageY:e.offsetY;if(S){let u=o;for(;u&&u.tagName!=="BODY";)i-=u.offsetLeft,c-=u.offsetTop,u=u.offsetParent}return{x:i,y:c}}catch(i){console.log(i)}},E={print:(e,o,i)=>y(o)||typeof i=="boolean",pretty:(e,o,i)=>y(o)&&y(e)||typeof i=="string",primary:(e,o)=>y(e)||typeof o=="boolean",success:(e,o)=>y(e)||typeof o=="boolean",info:(e,o)=>y(e)||typeof o=="boolean",warning:(e,o)=>y(e)||typeof o=="boolean",danger:(e,o)=>y(e)||typeof o=="boolean"};function _(e="default"){let o="";switch(e){case"primary":o="#2d8cf0";break;case"success":o="#19be6b";break;case"info":o="#909399";break;case"warning":o="#ff9900";break;case"danger":o="#ff4d4f";break;case"default":o="#35495E";break;default:o=e;break}return o}E.print=function(e,o="default",i=!1){return typeof e=="object"?(console.dir(e),!0):(i?console.log(`%c ${e} `,`background:${_(o)}; padding: 2px; border-radius: 4px;color: #fff;`):console.log(`%c ${e} `,`color: ${_(o)};`),!0)},E.pretty=function(e,o,i="primary"){return console.log(`%c ${e} %c ${o} %c`,`background:${_(i)};border:1px solid ${_(i)}; padding: 1px; border-radius: 4px 0 0 4px; color: #fff;`,`border:1px solid ${_(i)}; padding: 1px; border-radius: 0 4px 4px 0; color: ${_(i)};`,"background:transparent"),!0},E.primary=function(e,o=!1){return this.print&&this.print(e,"primary",o),!0},E.success=function(e,o=!1){return this.print&&this.print(e,"success",o),!0},E.info=function(e,o=!1){return this.print&&this.print(e,"info",o),!0},E.warning=function(e,o=!1){return this.print&&this.print(e,"warning",o),!0},E.danger=function(e,o=!1){return this.print&&this.print(e,"danger",o),!0};const Q={async install(e){e.config.globalProperties.$log=E,E.pretty("["+W.name+"] "+W.version,"success")}};process.env.NODE_ENV!=="production"&&Object.freeze({}),process.env.NODE_ENV!=="production"&&Object.freeze([]);const Z=e=>e!==null&&typeof e=="object",M=Symbol("wrapper"),H="__elPropsReservedKey";function ee(e,o){if(!Z(e)||e[H])return e;const{values:i,required:c,default:u,type:h,validator:d}=e,b=i||d?m=>{let w=!1,k=[];if(i&&(k=[...i,u],w=w||k.includes(m)),d&&(w=w||d(m)),!w&&k.length>0){const L=[...new Set(k)].map(j=>JSON.stringify(j)).join(", ");a.warn(`Invalid prop: validation failed${o?` for prop "${o}"`:""}. Expected one of [${L}], got value ${JSON.stringify(m)}.`)}return w}:void 0;return{type:typeof h=="object"&&h!==null&&Object.getOwnPropertySymbols(h).includes(M)?h[M]:h,validator:b,[H]:!0,default:u,required:!!c}}const te=(e=>G(Object.entries(e).map(([o,i])=>[o,ee(i,o)])))({canvasWidth:Number,canvasHeight:Number,lineColor:{type:String,default:"#000"},lineWidth:{type:Number,default:3},bgColor:{type:String,default:"#f7f7f7"},imgBgColor:{type:String,default:"transparent"},crop:{type:Boolean,default:!0},footer:{type:Boolean,default:!0},beforeDone:Function,erasable:{type:Boolean,default:!0},eraserRadius:{type:Number,default:6}}),ne={"on-clear":()=>!0,"on-done":e=>y(e),orientationchange:e=>A(e)},oe={class:"zm-sign"},ae={key:0,class:"zm-sign-tool"},se={class:"can_vans"},re=["width","height"],ie={key:1,class:"zm-sign-handle"},le=a.defineComponent({name:"Vue3Sign"}),N=a.defineComponent({...le,props:te,emits:ne,setup(e,{expose:o,emit:i}){const c=e,u=a.ref(0),h=a.ref(0);a.watch(()=>c.canvasWidth,t=>{u.value=t}),a.watch(()=>c.canvasHeight,t=>{h.value=t});const d=a.ref(),b=a.ref();a.onMounted(()=>{const t=d.value;t.style.background=c.bgColor,b.value=t.getContext("2d",{willReadFrequently:!0}),L(!0),document.onmouseup=()=>{V()};const{tapstart:n,tapend:r}=x();if(document.addEventListener(r,V),t.addEventListener(n,pe,{passive:!1}),typeof window<"u"){const s="onorientationchange"in window?"orientationchange":"resize";window.addEventListener(s,L,!1)}}),a.onBeforeUnmount(()=>{const{tapend:t}=x();if(document.removeEventListener(t,V),typeof window<"u"){const n="onorientationchange"in window?"orientationchange":"resize";window.removeEventListener(n,L,!1)}});const m=a.ref(!1),w=t=>{m.value=t,m.value?be(d.value):he(d.value)},k=a.ref(!1),L=t=>{const n=window.orientation;k.value=n==0||n==180,setTimeout(()=>{const r=window.innerWidth,s=window.innerHeight;k?j(r,s):de(r,s)},50),t!==!0&&i("orientationchange",n)},j=(t,n)=>{u.value=t-40,h.value=n/2},de=(t,n)=>{u.value=t-40,h.value=n-120},z=a.ref(!1),T=a.ref(!1),B=a.ref(0),I=a.ref(0),pe=t=>{if(t.cancelable&&t.preventDefault(),m.value)return;const n=$(t,d.value);if(n){z.value=!0,T.value=!0,B.value=n.x,I.value=n.y;const p=b.value;p.lineCap="round",p.lineJoin="round",p.strokeStyle=c.lineColor,p.lineWidth=c.lineWidth,X(n,"source-over")}const{tapmove:r,tapend:s}=x(),l=d.value;l.addEventListener(r,q,{passive:!1}),l.addEventListener(s,Y,{passive:!1})},q=t=>{if(t.cancelable&&t.preventDefault(),m.value||!z.value)return;const n=$(t,d.value);n&&(X(n,null),I.value=n.y,B.value=n.x)},Y=t=>{if(t.cancelable&&t.preventDefault(),m.value)return;const n=d.value,{tapmove:r,tapend:s}=x();n.removeEventListener(r,q),n.removeEventListener(s,Y)},X=({x:t,y:n},r)=>{const s=b.value;r&&(s.globalCompositeOperation=r),s.beginPath(),s.moveTo(B.value,I.value),s.lineTo(t,n),s.stroke(),s.closePath()},V=()=>{z.value=!1},J=()=>new Promise((n,r)=>{if(!T.value){r("Warning: Not Signned!");return}const s=d.value,l=b.value,p=l.getImageData(0,0,s.width,s.height);l.globalCompositeOperation="destination-over",l.fillStyle=c.bgColor,l.fillRect(0,0,s.width,s.height);let f=s.toDataURL();if(l.clearRect(0,0,s.width,s.height),l.putImageData(p,0,0),l.globalCompositeOperation="source-over",c.crop){const g=fe(p.data),v=document.createElement("canvas"),D=v.getContext("2d",{willReadFrequently:!0});v.width=g[2]-g[0],v.height=g[3]-g[1];const we=l.getImageData(...g);D.globalCompositeOperation="destination-over",D.putImageData(we,0,0),D.fillStyle=c.imgBgColor,D.fillRect(0,0,v.width,v.height),f=v.toDataURL(),v.width>0&&v.height>0?n(f):r("Warning: Not Signned!")}w(m.value),n(f)}),fe=t=>{const n=d.value;for(var r=n.width,s=0,l=n.height,p=0,f=0;f<n.width;f++)for(var g=0;g<n.height;g++){var v=(f+n.width*g)*4;(t[v]>0||t[v+1]>0||t[v+2]||t[v+3]>0)&&(p=Math.max(g,p),s=Math.max(f,s),l=Math.min(g,l),r=Math.min(f,r))}return r++,s++,l++,p++,[r,l,s,p]},ve=()=>{F(),i("on-clear")},O=a.ref(""),ge=()=>{let t=d.value,n=!0;c.beforeDone&&typeof c.beforeDone=="function"&&(n=c.beforeDone(t)),n&&J().then(r=>{O.value=r,i("on-done",O.value)}).catch(()=>{O.value="",i("on-done","")})},F=()=>{T.value=!1,w(m.value);const t=d.value;b.value.clearRect(0,0,t.width,t.height),O.value="",V()},me=async()=>await J(),he=t=>{const{tapstart:n}=x();b.value.globalCompositeOperation="source-over",t.removeEventListener(n,K)},be=t=>{if(!c.erasable)return;const{tapstart:n}=x(),r=b.value;r.lineCap="round",r.lineJoin="round",r.lineWidth=c.eraserRadius*2,r.globalCompositeOperation="destination-out",t.addEventListener(n,K,{passive:!1})},P=a.ref(0),R=a.ref(0),K=t=>{t.preventDefault();const n=d.value,{tapmove:r,tapend:s}=x();let l,p,f=$(t,n);P.value=f.x,R.value=f.y,U(P.value,R.value),n.addEventListener(r,v,{passive:!1}),n.addEventListener(s,g,{passive:!1});function g(){n.removeEventListener(r,v),n.removeEventListener(s,g)}function v(D){D.preventDefault(),f=$(D,n),f&&(l=f.x,p=f.y,U(P.value,R.value,l,p),P.value=l,R.value=p)}},U=(t,n,r,s)=>{const l=b.value;l.save(),l.beginPath(),r!==void 0&&s!==void 0?(l.arc(t,n,c.eraserRadius,0,2*Math.PI),l.fill()):(l.moveTo(t,n),l.lineTo(r,s),l.stroke()),l.restore()};return o({clear:F,done:me}),(t,n)=>(a.openBlock(),a.createElementBlock("div",oe,[t.erasable?(a.openBlock(),a.createElementBlock("div",ae,[a.createElementVNode("span",{class:a.normalizeClass(["iconfont","icon-eraser",{active:m.value}]),onClick:n[0]||(n[0]=r=>w(!m.value))},null,2)])):a.createCommentVNode("",!0),a.createElementVNode("div",se,[a.createElementVNode("canvas",{ref_key:"canvasRef",ref:d,width:t.canvasWidth?t.canvasWidth:u.value,height:t.canvasHeight?t.canvasHeight:h.value},null,8,re)]),t.footer?(a.openBlock(),a.createElementBlock("div",ie,[a.createElementVNode("button",{class:"zm-button zm-button--mini",onClick:ve}," 清空 "),a.createElementVNode("button",{class:"zm-button zm-button--mini",onClick:ge}," 完成 ")])):a.createCommentVNode("",!0)]))}});N.install=function(e){e.component(N.name,N)};const je="",ce=[N],ue={install:function(e){ce.forEach(o=>{e.component(o.name,o)}),e.use(Q)},Vue3Sign:N};C.Vue3Sign=N,C.default=ue,Object.defineProperties(C,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});
